name: Deploy Anchor (devnet)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "programs/**"
      - "Anchor.toml"
      - ".github/workflows/deploy-devnet.yml"

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Write Solana keypair from GitHub secret
      # --------------------------------------------------------
      - name: Write Solana keypair
        run: |
          mkdir -p ~/.config/solana
          echo '${{ secrets.SOLANA_KEYPAIR_JSON }}' > ~/.config/solana/id.json

      # --------------------------------------------------------
      # Build & Deploy USING DOCKER (NO Rust on host)
      # --------------------------------------------------------
      - name: Build & Deploy via Anchor Docker
        env:
          CLUSTER: devnet
        run: |
          set -euo pipefail

          # Use public Anchor docker image (works out-of-the-box)
          docker run --rm \
            -v "$PWD":/work \
            -w /work \
            -v "$HOME/.config/solana":/root/.config/solana \
            projectserum/anchor:latest \
            bash -c "
              anchor build &&
              anchor deploy --provider.cluster $CLUSTER &&
              solana address -k target/deploy/claim-keypair.json > program-id.txt &&
              cp target/idl/claim.json idl.json
            "

      # --------------------------------------------------------
      # Upload build artifacts
      # --------------------------------------------------------
      - name: Upload artifacts (PROGRAM_ID + IDL)
        uses: actions/upload-artifact@v4
        with:
          name: claim-idl-and-program
          path: |
            program-id.txt
            idl.json

      # --------------------------------------------------------
      # Optional: commit new program ID back to repo
      # --------------------------------------------------------
      - name: Commit program id (optional)
        if: always()
        run: |
          if [ -f program-id.txt ]; then
            PROGRAM_ID=$(cat program-id.txt)
            echo "$PROGRAM_ID" > PROGRAM_ID.devnet
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add PROGRAM_ID.devnet
            git commit -m "Update devnet program id -> $PROGRAM_ID" || true
            git push || true
          fi
