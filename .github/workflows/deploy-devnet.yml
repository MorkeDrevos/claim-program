name: Deploy Anchor (devnet)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "programs/**"
      - "Anchor.toml"
      - ".github/workflows/deploy-devnet.yml"

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # needed if you want to commit PROGRAM_ID.devnet

    env:
      SOLANA_VERSION: "1.18.22"
      ANCHOR_CLI_VERSION: "0.29.0"
      CLUSTER: "devnet"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Rust 1.76 ----
      - name: Install Rust 1.76
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.76.0

      - name: Show rustc version
        run: rustc --version

      # ---- Solana CLI ----
      - name: Install Solana CLI
        shell: bash
        run: |
          set -euo pipefail
          sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)" -- v${SOLANA_VERSION}
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      # ---- Anchor CLI ----
      - name: Install Anchor CLI
        run: |
          npm install -g @coral-xyz/anchor-cli@${ANCHOR_CLI_VERSION}
          anchor --version

      - name: Install jq (for IDL export)
        run: sudo apt-get update && sudo apt-get install -y jq

      # ---- Keypair + RPC ----
      - name: Configure keypair & RPC
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.config/solana"
          echo '${{ secrets.SOLANA_KEYPAIR_JSON }}' > "$HOME/.config/solana/id.json"
          chmod 600 "$HOME/.config/solana/id.json"

          RPC="${{ secrets.SOLANA_RPC_URL }}"
          if [ -z "$RPC" ]; then
            RPC="https://api.devnet.solana.com"
          fi

          solana config set --url "$RPC"
          solana address

      # ---- Pin versions in Cargo.lock on the runner ----
      - name: Pin dependency versions
        shell: bash
        run: |
          set -euo pipefail
          # Older versions that work with Solana's SBF rustc (1.75-dev-ish).
          # If some of these crates are not present, the command just fails and we ignore it.
          cargo update -p toml_datetime --precise 0.6.3 || true
          cargo update -p toml_edit     --precise 0.21.1 || true
          cargo update -p toml_parser   --precise 0.6.3 || true
          cargo update -p indexmap      --precise 2.2.6 || true

      # ---- Build ----
      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          ANCHOR_NO_CONFIG_WARN=1 anchor build

      # ---- Deploy to devnet ----
      - name: Deploy (devnet)
        shell: bash
        run: |
          set -euo pipefail
          anchor deploy --provider.cluster "${CLUSTER}"
          if [ -f target/deploy/claim-keypair.json ]; then
            PROGRAM_ID=$(solana address -k target/deploy/claim-keypair.json)
            echo "PROGRAM_ID=${PROGRAM_ID}" | tee program-id.txt
          else
            echo "target/deploy/claim-keypair.json missing – did the build succeed?"
          fi

      # ---- Export IDL ----
      - name: Export IDL
        shell: bash
        run: |
          set -euo pipefail
          cp target/idl/claim.json idl.json

      # ---- Upload PROGRAM_ID + IDL ----
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: claim-idl-and-program
          path: |
            program-id.txt
            idl.json

      # ---- Optionally commit PROGRAM_ID.devnet ----
      - name: Commit program id (optional)
        if: always()
        shell: bash
        run: |
          if [ -f program-id.txt ]; then
            PROGRAM_ID=$(cat program-id.txt)
            echo "$PROGRAM_ID" > PROGRAM_ID.devnet

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add PROGRAM_ID.devnet || true
            git commit -m "chore: update devnet program id -> $PROGRAM_ID" || echo "no changes"
            git push || true
          else
            echo "program-id.txt missing — skipping commit."
          fi
