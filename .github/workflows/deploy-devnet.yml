name: Deploy Anchor (devnet)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "programs/**"
      - "Anchor.toml"
      - ".github/workflows/deploy-devnet.yml"

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      SOLANA_VERSION: "1.18.22"
      ANCHOR_CLI_VERSION: "0.29.0"
      CLUSTER: devnet

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Toolchains: 1.74 to write a v3 lockfile, nightly to build
      - name: Install Rust 1.74 (for v3 Cargo.lock)
        uses: dtolnay/rust-toolchain@1.74.0

      - name: Install Rust nightly (for build)
        uses: dtolnay/rust-toolchain@nightly

      # Solana CLI
      - name: Install Solana CLI (tarball)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL -o solana.tar.bz2 "https://github.com/solana-labs/solana/releases/download/v${SOLANA_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2"
          mkdir -p "$HOME/solana-release"
          tar -xjf solana.tar.bz2 --strip-components=1 -C "$HOME/solana-release"
          echo "$HOME/solana-release/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/solana-release/bin:$PATH"
          solana --version

      # Anchor CLI
      - name: Install Anchor CLI
        run: |
          npm install -g @coral-xyz/anchor-cli@${ANCHOR_CLI_VERSION}
          anchor --version

      - name: Install jq (for IDL export)
        run: sudo apt-get update && sudo apt-get install -y jq

      # Keypair + RPC
      - name: Configure keypair & RPC
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.config/solana"
          echo '${{ secrets.SOLANA_KEYPAIR_JSON }}' > "$HOME/.config/solana/id.json"
          chmod 600 "$HOME/.config/solana/id.json"
          RPC="${{ secrets.SOLANA_RPC_URL }}"
          if [ -z "${RPC}" ]; then RPC="https://api.devnet.solana.com"; fi
          solana config set --url "$RPC"
          solana address

      # --- Make sure no patch blocks remain anywhere (root or programs/*) ---
      - name: Sanitize Cargo.toml (remove [patch.crates-io] blocks)
        shell: bash
        run: |
          set -euo pipefail
          sanitize() {
            local file="$1"
            [ -f "$file" ] || return 0
            if grep -q '^\[patch\.crates-io\]' "$file"; then
              awk 'BEGIN{skip=0}
                   /^\[patch\.crates-io\]/{skip=1; next}
                   skip && /^\[/{skip=0}
                   !skip{print}' "$file" > "$file.tmp"
              mv "$file.tmp" "$file"
              echo "Removed [patch.crates-io] from $file"
            fi
          }
          sanitize Cargo.toml
          find programs -maxdepth 2 -name Cargo.toml -print0 | while IFS= read -r -d '' f; do sanitize "$f"; done

      # --- Create a v3 lockfile on Rust 1.74 and pin transitive versions ---
      - name: Prepare v3 Cargo.lock (Rust 1.74, pin toml deps)
        shell: bash
        run: |
          set -euo pipefail
          rustup default 1.74.0
          # start from scratch to avoid stale state
          find . -name Cargo.lock -type f -print -delete || true
          cargo generate-lockfile
          cargo update -p toml_edit --precise 0.23.2
          cargo update -p toml_datetime --precise 0.7.2
          echo "Lockfile header:"
          head -n 5 Cargo.lock || true

      # --- Build on nightly, do NOT touch the lockfile ---
      - name: Build
        env:
          RUSTUP_TOOLCHAIN: nightly
        shell: bash
        run: |
          set -euo pipefail
          cargo clean || true
          ANCHOR_NO_CONFIG_WARN=1 anchor build

      - name: Deploy (devnet)
        env:
          RUSTUP_TOOLCHAIN: nightly
        shell: bash
        run: |
          set -euo pipefail
          anchor deploy --provider.cluster "${CLUSTER}"
          if [ -f target/deploy/claim-keypair.json ]; then
            PROGRAM_ID=$(solana address -k target/deploy/claim-keypair.json)
            echo "PROGRAM_ID=${PROGRAM_ID}" | tee program-id.txt
          fi

      - name: Export IDL
        shell: bash
        run: |
          set -euo pipefail
          cp target/idl/claim.json idl.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: claim-idl-and-program
          path: |
            program-id.txt
            idl.json

      - name: Commit program id (optional)
        if: always()
        shell: bash
        run: |
          if [ -f program-id.txt ]; then
            PROGRAM_ID=$(cat program-id.txt)
            echo "$PROGRAM_ID" > PROGRAM_ID.devnet
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add PROGRAM_ID.devnet || true
            git commit -m "chore: update devnet program id -> $PROGRAM_ID" || echo "no changes"
            git push || true
          else
            echo "program-id.txt missing â€” skipping commit."
          fi
