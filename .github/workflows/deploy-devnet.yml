name: Deploy Anchor (devnet)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "programs/**"
      - "Anchor.toml"
      - ".github/workflows/deploy-devnet.yml"

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # needed if you want to commit PROGRAM_ID.devnet

    env:
      CLUSTER: devnet
      ANCHOR_DOCKER_TAG: "v0.29.0"  # match your Anchor version

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Write the Solana keypair on the host (will be mounted into Docker)
      - name: Write Solana keypair
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.config/solana"
          echo '${{ secrets.SOLANA_KEYPAIR_JSON }}' > "$HOME/.config/solana/id.json"
          chmod 600 "$HOME/.config/solana/id.json"

      # Build & deploy completely INSIDE Anchor's Docker image
      - name: Build & Deploy via Anchor Docker
        env:
          RPC_URL: ${{ secrets.SOLANA_RPC_URL }}
        shell: bash
        run: |
          set -euo pipefail

          # Fallback to public devnet RPC if secret is empty
          if [ -z "${RPC_URL:-}" ]; then
            RPC_URL="https://api.devnet.solana.com"
          fi

          echo "Using RPC_URL=$RPC_URL"

          docker run --rm \
            -v "$PWD":/workdir \
            -v "$HOME/.config/solana:/root/.config/solana:ro" \
            -w /workdir \
            -e ANCHOR_PROVIDER_URL="$RPC_URL" \
            -e CLUSTER="$CLUSTER" \
            solanafoundation/anchor:${ANCHOR_DOCKER_TAG} \
            bash -lc '
              set -euo pipefail
              echo "Anchor version inside container:"
              anchor --version
              echo "Solana version inside container:"
              solana --version

              # Make sure Solana uses the same RPC URL
              solana config set --url "$ANCHOR_PROVIDER_URL"

              # Build & deploy
              anchor build
              anchor deploy --provider.cluster "$CLUSTER"

              # Export program id (if keypair exists)
              if [ -f target/deploy/claim-keypair.json ]; then
                solana address -k target/deploy/claim-keypair.json > program-id.txt
              fi

              # Export IDL
              cp target/idl/claim.json idl.json
            '

      - name: Upload artifacts (PROGRAM_ID + IDL)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claim-idl-and-program
          path: |
            program-id.txt
            idl.json

      - name: Commit program id (optional)
        if: always()
        shell: bash
        run: |
          if [ -f program-id.txt ]; then
            PROGRAM_ID=$(cat program-id.txt)
            echo "$PROGRAM_ID" > PROGRAM_ID.devnet
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add PROGRAM_ID.devnet || true
            git commit -m "chore: update devnet program id -> $PROGRAM_ID" || echo "no changes"
            git push || true
          else
            echo "program-id.txt missing â€” skipping commit."
          fi
